# Object Harvest

Object Harvest is a tool for generating and processing object-related data, including prompt generation using LLMs and image generation from prompts.

## Features

- **Prompt Generation (`prompt-gen`)**: Generate scene descriptions containing specified objects using OpenAI-compatible LLMs (e.g., via OpenRouter).
- **Prompt Enhancement (`prompt-enhance`)**: Enhance prompts generated by `prompt-gen` using Qwen T2I prompt optimizer.
- **Image Generation (`image-gen`)**: Generate images from NDJSON prompts (not yet implemented).
- **Multi-threading**: Efficient parallel processing with configurable rate limiting.
- **NDJSON Output**: Structured output for easy processing.

## Installation

1. Ensure you have Python ≥ 3.12 installed.
2. Clone the repository and navigate to the project directory.
3. Install dependencies using `uv`:

   ```bash
   uv venv
   uv install --dev
   ```

## Setup

### API Keys
For LLM access, set your API key as an environment variable:

```bash
export OPENROUTER_API_KEY="your-api-key-here"
```

Or pass it via the `--api-key` CLI argument.

## Usage

### General Command Structure

```bash
uv run python -m obh.generate <task> [options]
```

Or using the installed script:

```bash
obh-generate <task> [options]
```

### Tasks

#### Prompt Generation (`prompt-gen`)

Generates scene descriptions containing the specified objects using an LLM.

**Required Arguments:**
- `--num-prompts`: Number of prompts to generate
- `--output`: Path to output NDJSON file

**Object Input (choose one):**
- `--objects-file`: Text file with objects (one per line, format: `object — descriptor`)
- `--objects-list`: Comma-separated list (format: `object — descriptor`)

**Optional Arguments:**
- `--rpm`: Requests per minute limit (default: 60)
- `--model`: LLM model (default: `openai/gpt-4o`)
- `--base-url`: API base URL (default: `https://openrouter.ai/api/v1`)
- `--api-key`: API key (overrides env var)
- `--batch-size`: Batch size for processing (default: 100)
- `--min-objects`: Minimum number of objects to randomly select per prompt (must be used with `--max-objects`)
- `--max-objects`: Maximum number of objects to randomly select per prompt (must be used with `--min-objects`)

**Example:**

```bash
# Using objects list with random object selection
uv run python -m obh.generate prompt-gen \
  --objects-list "apple — red, shiny; banana — yellow, curved; orange — orange, round" \
  --num-prompts 5 \
  --min-objects 1 \
  --max-objects 2 \
  --output prompts.ndjson

# Using objects file with fixed batch size
echo "apple — red, shiny" > objects.txt
echo "banana — yellow, curved" >> objects.txt
echo "orange — orange, round" >> objects.txt
uv run python -m obh.generate prompt-gen \
  --objects-file objects.txt \
  --num-prompts 10 \
  --rpm 30 \
  --batch-size 50 \
  --output prompts.ndjson
```

**Output Format:**
Each line in the NDJSON file is a JSON object with:
- `describe`: The generated scene description
- `objects`: Array of objects with their exact phrasing in the description

**Processing Details:**
- Uses multi-threaded batch processing for efficient generation
- Displays progress bars for each batch
- Prints a summary of attempted, successful, and failed generations at the end

#### Image Generation (`image-gen`)

Generates images from NDJSON prompts using Transformers diffusion models.

**Note:** This task is not yet implemented.

**Planned Arguments:**
- `--input`: Path to input NDJSON file from `prompt-gen`
- `--output-dir`: Directory to save generated images

#### Prompt Enhancement (`prompt-enhance`)

Enhances prompts generated by `prompt-gen` using the Qwen T2I prompt optimizer to create more detailed and expressive prompts while preserving the original meaning.

**Required Arguments:**
- `--input`: Path to input NDJSON file generated by `prompt-gen`
- `--output`: Path to output NDJSON file

**Optional Arguments:**
- `--rpm`: Requests per minute limit (default: 60)
- `--model`: LLM model (default: `openai/gpt-4o`)
- `--base-url`: API base URL (default: `https://openrouter.ai/api/v1`)
- `--api-key`: API key (overrides env var)
- `--batch-size`: Batch size for processing (default: 100)

**Example:**

```bash
# Enhance prompts generated by prompt-gen
uv run python -m obh.generate prompt-enhance \
  --input prompts.ndjson \
  --output enhanced_prompts.ndjson \
  --rpm 30 \
  --batch-size 50
```

**Output Format:**
Each line in the NDJSON file is a JSON object with:
- `describe`: The original scene description from `prompt-gen`
- `objects`: Array of objects with their exact phrasing in the description
- `prompt`: The enhanced prompt generated by Qwen T2I prompt optimizer

**Processing Details:**
- Uses multi-threaded batch processing for efficient enhancement
- Displays progress bars for each batch
- Prints the total number of enhanced prompts at the end

## Development

### Code Style
- Use `uv run ruff check --fix .` to lint and format code.
- Run `uv run pytest` for tests (add tests under `tests/`).

### Project Structure
- `obh/`: Main package
  - `generate.py`: CLI entry point for generation tasks
  - `utils/`: Shared utilities
    - `llm_utils.py`: LLM-related helper functions
- `tests/`: Unit tests

## Contributing

Follow the guidelines in `AGENTS.md` for code style, testing, and PR workflow.